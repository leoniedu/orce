% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/orce.R
\name{orce}
\alias{orce}
\title{Alocação Otimizada de Unidades de Coleta (UCs) a Agências}
\usage{
orce(
  ucs,
  agencias = data.frame(agencia_codigo = unique(ucs$agencia_codigo),
    n_entrevistadores_agencia_max = Inf, custo_fixo = 0, diaria_valor =
    diaria_valor_get(unique(ucs$agencia_codigo))),
  alocar_por = "uc",
  custo_litro_combustivel = 6,
  custo_hora_viagem = 10,
  kml = 10,
  diarias_entrevistador_max = Inf,
  remuneracao_entrevistador = 0,
  n_entrevistadores_min = 1,
  n_entrevistadores_tipo = "integer",
  dias_coleta_entrevistador_max,
  dias_treinamento = 0,
  agencias_treinadas = NULL,
  agencias_treinamento = NULL,
  distancias_ucs,
  distancias_agencias = NULL,
  adicional_troca_jurisdicao = 0,
  resultado_completo = FALSE,
  solver = "highs",
  rel_tol = 0.005,
  max_time = 30 * 60,
  use_cache = TRUE,
  distancias_nos = NULL,
  peso_tsp = 0,
  orce_function = orce_model_mip,
  ...
)
}
\arguments{
\item{ucs}{Um \code{tibble} ou \code{data.frame} contendo informações sobre as UCs, incluindo:
\itemize{
\item \code{uc}: Código único da UC.
\item \code{agencia_codigo}: Código da agência à qual a UC está atualmente alocada.
\item \code{dias_coleta}: Número de dias de coleta na UC, por período.
\item \code{viagens}: Número de viagens necessárias para a coleta na UC, por período.
\item \code{data}: Um identificador único para o período de coleta (e.g., "2024-01", "2024-02").
\item \code{diaria_valor}: Valor da diária para a UC.
\item \code{alocar_por}: Uma coluna adicional para agrupar as UCs antes da alocação (e.g., "setor", "municipio").
}}

\item{agencias}{Um \code{tibble} ou \code{data.frame} contendo informações sobre as agências selecionáveis, incluindo:
\itemize{
\item \code{agencia_codigo}: Código único da agência.
\item \code{n_entrevistadores_agencia_max}: Número máximo de entrevistadores por agência. Junto com \code{dias_coleta_entrevistador_max},
determina o número máximo de dias de coleta que a agência pode realizar (n_entrevistadores_agencia_max * dias_coleta_entrevistador_max).
\item \code{custo_fixo}: Custo fixo associado à agência (soma de todos os períodos).
}}

\item{alocar_por}{Uma string especificando como alocar as UCs: "uc" para alocar cada UC individualmente, ou o nome de uma coluna em \code{ucs} para agrupar as UCs antes da alocação (e.g., "setor", "municipio"). Padrão: "uc".}

\item{custo_litro_combustivel}{Custo do combustível por litro (em R$). Padrão: 6.}

\item{custo_hora_viagem}{Custo de cada hora de viagem (em R$). Padrão: 10.}

\item{kml}{Consumo médio de combustível do veículo (em km/l). Padrão: 10.}

\item{diarias_entrevistador_max}{Total máximo de diárias que um entrevistador pode receber, somando todos os períodos. Padrão: \code{Inf}.}

\item{remuneracao_entrevistador}{Remuneração total por entrevistador para todos os períodos. Padrão: 0.}

\item{n_entrevistadores_min}{Número mínimo de entrevistadores por agência. Padrão: 1.}

\item{dias_coleta_entrevistador_max}{Número máximo de dias de coleta por entrevistador por período.}

\item{dias_treinamento}{Número de dias/diárias para treinamento. Padrão: 0 (nenhum treinamento).}

\item{agencias_treinadas}{(Opcional) Um vetor de caracteres com os códigos das agências que já foram treinadas e não terão custo de treinamento. Padrão: NULL.}

\item{agencias_treinamento}{Código da(s) agência(s) onde o treinamento será realizado.}

\item{distancias_ucs}{Um \code{tibble} ou \code{data.frame} com as distâncias entre UCs e agências, incluindo:
\itemize{
\item \code{uc}: Código da UC.
\item \code{agencia_codigo}: Código da agência.
\item \code{distancia_km}: Distância em quilômetros entre a UC e a agência.
\item \code{duracao_horas}: Duração da viagem em horas entre a UC e a agência.
\item \code{diaria_municipio}: Indica se é necessária uma diária para deslocamento entre a UC e a agência, considerando o município da UC.
\item \code{diaria_pernoite}: Indica se é necessária uma diária com pernoite para deslocamento entre a UC e a agência.
}}

\item{distancias_agencias}{Um \code{tibble} ou \code{data.frame} com as distâncias entre as agências, incluindo:
\itemize{
\item \code{agencia_codigo_orig}: Código da agência de origem.
\item \code{agencia_codigo_dest}: Código da agência de destino.
\item \code{distancia_km}: Distância em quilômetros entre a agência de origem e a de destino.
\item \code{duracao_horas}: Duração da viagem em horas entre a agência de origem e a de destino.
}}

\item{adicional_troca_jurisdicao}{Custo adicional quando há troca de agência de coleta. Padrão: 0.}

\item{resultado_completo}{(Opcional) Um valor lógico indicando se deve ser retornado um resultado mais completo, incluindo informações sobre todas as combinações de UCs e agências. Padrão: FALSE.}

\item{solver}{Qual ferramenta para solução do modelo de otimização utilizar. Padrão: "cbc". Outras opções: "glpk", "symphony" (instalação manual).}

\item{rel_tol}{Tolerância relativa para a otimização. Valores menores levam a soluções mais precisas, mas podem aumentar o tempo de execução. Padrão: 0.005.}

\item{max_time}{Tempo máximo de execução (em segundos) permitido para o solver. Padrão: 30*60 (30 minutos).}

\item{use_cache}{Lógico indicando se deve usar resultados em cache. Quando TRUE,
resultados para entradas idênticas serão recuperados do cache em disco em vez
de recalcular. Isso pode acelerar cálculos repetidos mas usa espaço em disco.
O padrão é TRUE.}

\item{distancias_nos}{Matriz N × N de distâncias (em km) entre todos os nós do
grafo de roteamento, onde N = m agências + n UCs. As primeiras m linhas/colunas
correspondem às agências (bases) e as n seguintes às UCs. Obrigatório quando
\code{peso_tsp > 0}. Pode ser fornecida como matriz numérica já indexada ou como
\code{data.frame} longo com colunas \code{orig}, \code{dest} e \code{distancia_km}.}

\item{peso_tsp}{Peso para a penalidade de coerência geográfica baseada em TSP.
Quando \verb{> 0}, o modelo adiciona ao objetivo um termo proporcional ao
comprimento da rota de cada agência, desincentivando atribuições territorialmente
fragmentadas. UCs geograficamente próximas tendem a ser agrupadas na mesma agência
porque a rota conjunta é mais curta. Não substitui o custo real de deslocamento
(\code{transport_cost_i_j}); atua como ajuste de coerência geográfica. Padrão: 0
(sem penalidade TSP).}

\item{orce_function}{Função construtora do modelo OMPR a ser usada. Recebe um único
argumento \code{env} (um ambiente) com todos os objetos já preparados dentro de \code{.orce_impl}
e deve retornar um objeto \code{ompr::MIPModel}. O padrão é \code{orce_model_default}.}

\item{...}{Opções adicionais para o solver.}
}
\value{
Uma lista contendo:
\itemize{
\item \code{resultado_ucs_jurisdicao}: Um \code{tibble} com as UCs e suas alocações originais (jurisdição), incluindo custos de deslocamento.
\item \code{resultado_agencias_jurisdicao}: Um \code{tibble} com as agências e suas alocações originais (jurisdição), incluindo custos fixos, custos de deslocamento e número de UCs alocadas.
\item \code{resultado_ucs_otimo}: Um \code{tibble} com as UCs e suas alocações otimizadas, incluindo custos de deslocamento.
\item \code{resultado_agencias_otimo}: Um \code{tibble} com as agências e suas alocações otimizadas, incluindo custos fixos, custos de deslocamento, número de UCs alocadas e número de entrevistadores.
\item \code{ucs_agencias_todas} (opcional): Um \code{tibble} com todas as combinações de UCs e agências, incluindo distâncias, custos e informações sobre diárias (retornado apenas se \code{resultado_completo} for TRUE).
\item \code{otimizacao} (opcional): O resultado completo da otimização (retornado apenas se \code{resultado_completo} for TRUE).
\item \code{log} (opcional): últimas 100 linhas do log de execução do solver.
}
}
\description{
Esta função realiza a alocação otimizada de Unidades de Coleta (UCs) a agências, com o objetivo de minimizar os custos totais de deslocamento e operação, considerando múltiplos períodos de coleta. A alocação leva em consideração restrições de capacidade das agências (em número de dias de coleta por período), custos de deslocamento (combustível, tempo de viagem e diárias), custos fixos das agências e custos de treinamento. Quando \code{use_cache = TRUE}, os resultados são armazenados em cache no disco e reutilizados para entradas idênticas, o que pode acelerar significativamente cálculos repetidos. A função \code{limpar_cache_ucs} auxilia na limpeza desse cache em disco. A função procede utilizando apenas as colunas requeridas para o processamento.
}
